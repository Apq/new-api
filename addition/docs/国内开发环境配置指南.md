# 国内开发环境配置指南

本文档介绍如何在国内网络环境下搭建 New API 的本地开发调试环境。

## 环境要求

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| Go | >= 1.25 | 后端开发 |
| Node.js | >= 20.x | 前端开发 |
| npm | >= 10.x | 包管理器（随 Node.js 安装） |
| Git | 最新版 | 版本控制 |

## 一、安装开发工具

### Windows

下载安装包并按提示安装：

1. **Go**: https://golang.google.cn/dl/ （选择 `.msi` 安装包）
2. **Node.js**: https://npmmirror.com/mirrors/node/ （选择 LTS 版本的 `.msi` 安装包）
3. **Git**: https://registry.npmmirror.com/-/binary/git-for-windows/ （选择最新版 `.exe` 安装包）

> 安装时建议勾选"添加到 PATH 环境变量"选项

> **重要提示**：安装完成后，需要**关闭所有 VS Code 窗口、命令行终端、PowerShell 等**，然后重新打开，否则环境变量不会生效，会出现"无法识别命令"的错误。

### Linux (Ubuntu/Debian)

```bash
# 安装 Node.js 20.x（使用国内镜像）
curl -fsSL https://registry.npmmirror.com/-/binary/node/v20.18.0/node-v20.18.0-linux-x64.tar.xz -o node.tar.xz
sudo tar -xJf node.tar.xz -C /usr/local --strip-components=1
rm node.tar.xz

# 安装 Go（使用国内镜像）
wget https://golang.google.cn/dl/go1.25.1.linux-amd64.tar.gz
sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.25.1.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# 安装 Git
sudo apt install -y git
```

## 二、验证安装

```bash
go version      # 应显示 go version go1.25.x
node -v         # 应显示 v20.x.x
npm -v          # 应显示 10.x.x
git --version   # 应显示 git version x.x.x
```

## 三、配置国内镜像（重要）

### Go 代理

```bash
go env -w GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,direct
go env -w GO111MODULE=on
```

### npm 镜像

```bash
npm config set registry https://registry.npmmirror.com
```

### 验证配置

```bash
go env GOPROXY           # 应显示 https://goproxy.cn,...
npm config get registry  # 应显示 https://registry.npmmirror.com
```

## 四、克隆项目

```bash
# SSH 方式（推荐，需先配置 SSH Key）
git clone git@gitee.com:your-username/apq-new-api.git

# 或 HTTPS 方式
git clone https://gitee.com/your-username/apq-new-api.git

cd apq-new-api
```

## 五、配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env
```

编辑 `.env` 文件：

```bash
# 基础配置（开发环境使用默认值即可）
PORT=3000
DEBUG=true

# 数据库配置（默认使用 SQLite，无需额外配置）
# 如需使用 MySQL：
# SQL_DSN=user:password@tcp(127.0.0.1:3306)/newapi?parseTime=true
```

## 六、启动开发服务

### 构建前端

后端代码中嵌入了前端构建产物，首次运行前必须先构建前端：

```bash
cd web
npm install --legacy-peer-deps    # 安装依赖
npm run build                      # 构建前端
cd ..
```

### 启动后端

```bash
# 在项目根目录
go mod download    # 下载依赖
go run main.go     # 启动服务
```

后端服务：`http://localhost:3000`

### 启动前端开发服务器（可选）

如果需要前端热更新开发，可以额外启动前端开发服务器：

打开新终端：

```bash
cd web
npm run dev    # 启动开发服务器（依赖已在构建前端时安装）
```

前端服务：`http://localhost:5173`

## 七、访问应用

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端 | http://localhost:5173 | 支持热更新 |
| 后端 | http://localhost:3000 | API 服务 |

前端已配置代理，`/api` 请求会自动转发到后端。

## 八、常见问题

### 1. npm install 失败

```bash
# 确认使用国内镜像
npm config set registry https://registry.npmmirror.com

# 清除缓存重试
npm cache clean --force
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps
```

### 2. Go 依赖下载慢

```bash
# 确认代理配置
go env -w GOPROXY=https://goproxy.cn,direct
```

### 3. 端口被占用

```bash
# Windows
netstat -ano | findstr :3000

# Linux
lsof -i :3000
```

### 4. Git 克隆慢

使用 Gitee 镜像仓库，或配置 Git 代理。

### 5. 前端开发服务器端口不是 5173

Vite 默认使用 5173 端口，但如果该端口被占用（包括被其他程序的出站连接占用），会自动递增到 5174、5175 等。

```bash
# 查看 5173 端口占用情况
netstat -ano | findstr :5173

# 查看占用进程
tasklist | findstr <PID>
```

解决方法：关闭占用端口的程序，或直接使用 Vite 自动分配的端口（终端会显示实际地址）。

## 九、构建生产版本

```bash
# 构建前端
cd web
npm run build

# 构建后端
go build -o new-api main.go
```
