# 用户注册流程详解

## 一、概述

本系统支持两种用户创建方式：

| 方式 | 入口 | 操作者 | 特点 |
|-----|------|-------|------|
| 用户自主注册 | `/register` 页面 | 用户 | 功能受限，使用系统默认配置 |
| 管理员创建 | 管理后台 → 用户管理 | 管理员 | 功能完整，可自定义所有参数 |

## 二、用户自主注册

### 2.1 注册入口

**路由**: `POST /api/user/register`

**中间件**:
- `CriticalRateLimit()` - 关键操作限流（默认 60次/10分钟）
- `TurnstileCheck()` - Cloudflare Turnstile 人机验证（可选）

### 2.2 前端流程

**文件**: `web/src/components/auth/RegisterForm.jsx`

```
用户访问注册页面
       ↓
┌─────────────────────────────────────┐
│  检查是否有第三方登录选项            │
│  (GitHub/Discord/微信/LinuxDO等)    │
└─────────────────────────────────────┘
       ↓
   有第三方选项?
   ├─ 是 → 显示 OAuth 选项页面
   │        ├─ 微信扫码登录
   │        ├─ GitHub 登录
   │        ├─ Discord 登录
   │        ├─ OIDC 登录
   │        ├─ LinuxDO 登录
   │        ├─ Telegram 登录
   │        └─ "使用用户名注册" 按钮
   │
   └─ 否 → 直接显示用户名注册表单
```

**用户名注册表单字段**:

| 字段 | 必填 | 说明 |
|-----|------|------|
| 用户名 | 是 | 唯一标识 |
| 密码 | 是 | 8-20位 |
| 确认密码 | 是 | 需与密码一致 |
| 邮箱 | 条件 | 仅当 `email_verification` 启用时 |
| 验证码 | 条件 | 仅当 `email_verification` 启用时 |
| 邀请码 | 否 | URL参数 `?aff=xxx` 或 localStorage |
| 用户协议 | 条件 | 仅当启用用户协议/隐私政策时 |

### 2.3 后端流程

**文件**: `controller/user.go` - `Register()` 函数

```
收到注册请求
       ↓
1. 检查全局开关
   ├─ RegisterEnabled = false → 返回"管理员关闭了新用户注册"
   └─ PasswordRegisterEnabled = false → 返回"请使用第三方账户验证"
       ↓
2. 参数验证
   ├─ 解析请求体
   └─ 验证用户名/密码格式
       ↓
3. 邮箱验证（如果启用）
   ├─ 检查邮箱和验证码是否提供
   └─ 验证验证码是否正确
       ↓
4. 用户名检查
   └─ CheckUserExistOrDeleted() → 检查用户名是否已存在或已注销
       ↓
5. 处理邀请码
   └─ GetUserIdByAffCode() → 获取邀请人ID
       ↓
6. 创建用户对象
   cleanUser := {
     Username:    用户输入
     Password:    用户输入（会被哈希）
     DisplayName: 默认=用户名
     InviterId:   邀请人ID
     Role:        RoleCommonUser (普通用户)
     Email:       用户输入（如果启用邮箱验证）
   }
       ↓
7. 调用 user.Insert(inviterId)
       ↓
8. 生成默认令牌（如果 GenerateDefaultToken = true）
```

### 2.4 用户插入逻辑

**文件**: `model/user.go` - `Insert()` 方法

```go
func (user *User) Insert(inviterId int) error {
    // 1. 密码哈希
    user.Password = Password2Hash(user.Password)

    // 2. 设置初始额度（系统配置）
    user.Quota = common.QuotaForNewUser  // 默认 0

    // 3. 生成邀请码
    user.AffCode = GetRandomString(4)

    // 4. 初始化用户设置
    user.SetSetting(defaultSetting)

    // 5. 插入数据库
    DB.Create(user)

    // 6. 初始化边栏配置（基于角色）

    // 7. 记录新用户赠送日志
    if QuotaForNewUser > 0 {
        RecordLog("新用户注册赠送 xxx")
    }

    // 8. 处理邀请奖励
    if inviterId != 0 {
        // 被邀请人奖励
        if QuotaForInvitee > 0 {
            IncreaseUserQuota(user.Id, QuotaForInvitee)
        }
        // 邀请人奖励
        if QuotaForInviter > 0 {
            inviteUser(inviterId)  // 增加邀请人的 AffQuota
        }
    }
}
```

### 2.5 生成默认令牌（可选）

如果环境变量 `GENERATE_DEFAULT_TOKEN=true`：

```go
token := Token{
    UserId:         insertedUser.Id,
    Name:           "用户名的初始令牌",
    Key:            GenerateKey(),
    ExpiredTime:    -1,      // 永不过期
    RemainQuota:    500000,  // 硬编码的示例额度
    UnlimitedQuota: true,
    Group:          "auto"   // 如果 DefaultUseAutoGroup 启用
}
```

### 2.6 自主注册的限制

| 项目 | 自主注册 | 说明 |
|-----|---------|------|
| 用户类型 | 固定为计量用户 (UserType=0) | 无法选择其他类型 |
| 分组 | 使用系统默认分组 | 无法自定义 |
| 初始额度 | QuotaForNewUser 配置值 | 默认为 0 |
| 用户凭证 | 不创建 | 需要用户自行生成或管理员创建 |
| 令牌 | 可选（需配置） | GenerateDefaultToken=true 时创建 |

---

## 三、管理员创建用户

### 3.1 单个创建

**路由**: `POST /api/user/`

**权限**: 需要管理员权限

**文件**: `controller/user.go` - `CreateUser()` 函数

**请求参数**:

```json
{
  "username": "string",       // 必填，用户名
  "password": "string",       // 必填，密码
  "display_name": "string",   // 可选，显示名称
  "remark": "string",         // 可选，备注（仅管理员可见）
  "user_type": 0,             // 可选，用户类型
  "group": "default",         // 可选，分组
  "quota": 100,               // 可选，初始额度（美元）
  "generate_token": false     // 可选，是否自动生成令牌
}
```

**用户类型选项**:

| 值 | 类型 | 说明 |
|---|------|------|
| 0 | 计量 | 按使用量计费 |
| 1 | 天卡 | 不限量，1天有效 |
| 7 | 周卡 | 不限量，7天有效 |
| 30 | 月卡 | 不限量，30天有效 |
| 90 | 季卡 | 不限量，90天有效 |
| 180 | 半年卡 | 不限量，180天有效 |
| 365 | 年卡 | 不限量，365天有效 |
| 2147483647 | 永久 | 不限量，永久有效 |

**响应数据**:

```json
{
  "success": true,
  "message": "",
  "data": {
    "id": 123,
    "username": "newuser",
    "access_token": "abc123...",      // 用户凭证
    "token_key": "sk-xxx..."          // 如果选择生成令牌
  }
}
```

### 3.2 批量创建

**路由**: `POST /api/user/batch`

**权限**: 需要管理员权限

**文件**: `controller/user.go` - `BatchCreateUsers()` 函数

**请求参数**:

```json
{
  "user_type": 0,              // 必填，用户类型
  "count": 100,                // 必填，数量（1-10000）
  "username_prefix": "user_",  // 必填，用户名前缀（最多15字符）
  "quota": 100,                // 必填，初始额度（美元）
  "group": "default",          // 必填，分组
  "generate_token": true       // 可选，是否自动生成令牌
}
```

**响应数据**:

```json
{
  "success": true,
  "message": "成功创建 100 个用户，失败 0 个",
  "data": [
    {
      "username": "user_1234567890001",
      "password": "randomPass123",
      "access_token": "abc123...",
      "token_key": "sk-xxx..."
    },
    // ...
  ]
}
```

### 3.3 管理员创建的特点

| 项目 | 管理员创建 | 说明 |
|-----|----------|------|
| 用户类型 | 可选择任意类型 | 计量/天卡/周卡/月卡等 |
| 分组 | 可自定义 | 从系统分组列表选择 |
| 初始额度 | 可自定义 | 以美元为单位输入 |
| 用户凭证 | 自动创建 | 用于凭证登录 |
| 令牌 | 可选 | 勾选后自动创建 |
| 密码 | 单个创建需输入，批量自动生成 | 批量创建生成12位随机密码 |

---

## 四、关键配置项

### 4.1 注册相关配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|-------|---------|-------|------|
| RegisterEnabled | - | true | 是否允许注册 |
| PasswordRegisterEnabled | - | true | 是否允许密码注册 |
| EmailVerificationEnabled | - | false | 是否需要邮箱验证 |
| TurnstileCheckEnabled | TURNSTILE_CHECK | false | 是否启用人机验证 |

### 4.2 额度相关配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|-------|---------|-------|------|
| QuotaForNewUser | QUOTA_FOR_NEW_USER | 0 | 新用户初始额度 |
| QuotaForInviter | QUOTA_FOR_INVITER | 0 | 邀请人奖励额度 |
| QuotaForInvitee | QUOTA_FOR_INVITEE | 0 | 被邀请人奖励额度 |

### 4.3 令牌相关配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|-------|---------|-------|------|
| GenerateDefaultToken | GENERATE_DEFAULT_TOKEN | false | 自主注册是否自动生成令牌 |
| DefaultUseAutoGroup | - | false | 默认令牌是否使用 auto 分组 |

---

## 五、流程对比

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户创建流程对比                               │
├─────────────────────────────────┬───────────────────────────────────────┤
│         用户自主注册             │           管理员创建用户              │
├─────────────────────────────────┼───────────────────────────────────────┤
│                                 │                                       │
│  用户访问 /register             │  管理员访问 用户管理页面               │
│         ↓                       │         ↓                             │
│  填写用户名、密码               │  填写用户名、密码                      │
│  (可选: 邮箱、验证码、邀请码)    │  选择用户类型、分组                    │
│         ↓                       │  设置初始额度                          │
│  POST /api/user/register        │  选择是否生成令牌                      │
│         ↓                       │         ↓                             │
│  检查注册开关                   │  POST /api/user/                       │
│  验证邮箱(如果启用)             │         ↓                             │
│  检查用户名                     │  验证参数                              │
│         ↓                       │  检查权限                              │
│  user.Insert()                  │         ↓                             │
│  - Quota = QuotaForNewUser      │  DB.Create()                          │
│  - Group = 默认                 │  - Quota = 自定义                      │
│  - UserType = 0 (计量)          │  - Group = 自定义                      │
│         ↓                       │  - UserType = 自定义                   │
│  处理邀请奖励                   │         ↓                             │
│         ↓                       │  创建用户凭证                          │
│  生成默认令牌(如果配置)         │  生成令牌(如果选择)                    │
│         ↓                       │         ↓                             │
│  返回成功                       │  返回用户信息                          │
│  跳转登录页                     │  (用户名、密码、凭证、令牌)            │
│                                 │                                       │
└─────────────────────────────────┴───────────────────────────────────────┘
```

---

## 六、安全考虑

### 6.1 限流保护

- 自主注册受 `CriticalRateLimit` 保护（默认 60次/10分钟）
- 可启用 Turnstile 人机验证防止机器人注册

### 6.2 权限控制

- 管理员只能创建权限低于自己的用户
- 普通管理员无法创建超级管理员

### 6.3 密码安全

- 密码最短 8 位
- 存储时使用 bcrypt 哈希
- 批量创建使用 12 位随机密码

### 6.4 用户名检查

- 检查用户名是否已存在
- 检查用户名是否已被注销（防止重复使用）

---

## 七、相关文件

| 文件路径 | 说明 |
|---------|------|
| `controller/user.go` | 用户相关 API 控制器 |
| `model/user.go` | 用户数据模型 |
| `web/src/components/auth/RegisterForm.jsx` | 注册页面前端组件 |
| `web/src/components/table/users/modals/AddUserModal.jsx` | 添加用户弹窗 |
| `web/src/components/table/users/modals/BatchAddUserModal.jsx` | 批量添加用户弹窗 |
| `common/constants.go` | 全局常量配置 |
| `constant/env.go` | 环境变量配置 |
