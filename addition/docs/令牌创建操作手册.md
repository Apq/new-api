# 令牌创建操作手册

## 一、概述

令牌（Token/API Key）是用户调用 API 的凭证。每个令牌可以独立配置额度、过期时间、可用模型、分组等属性，方便用户管理不同用途的 API 访问。

### 核心文件

| 文件路径 | 功能描述 |
|---------|---------|
| `controller/token.go` | 令牌 CRUD 接口 |
| `controller/group.go` | 用户可用分组查询接口 |
| `model/token.go` | 令牌数据模型 |
| `service/group.go` | 分组权限计算逻辑 |
| `setting/user_usable_group.go` | 用户可用分组配置 |
| `setting/auto_group.go` | 自动分组配置 |

## 二、创建令牌入口

**路径**: 控制台 → 令牌管理 → 新建令牌

**前端组件**: `web/src/components/table/tokens/modals/EditTokenModal.jsx`

## 三、令牌属性详解

### 1. 名称

- **必填项**
- 用于标识令牌用途
- 批量创建时会自动在名称后添加随机后缀（如 `mytoken-Abc123`）

### 2. 令牌分组

令牌分组决定了该令牌可以使用哪些渠道。

#### 分组类型

| 分组类型 | 说明 |
|---------|------|
| 固定分组 | 如 `default`、`vip`，只能使用该分组下的渠道 |
| `auto` 分组 | 智能分组，可动态使用多个分组的渠道 |
| 留空 | 使用用户的默认分组 |

#### `auto` 分组工作机制

当令牌分组设为 `auto` 时：

```
请求进入
    ↓
获取 AutoGroups 列表（管理员配置）
    ↓
按顺序尝试各分组的渠道
    ↓
第一个分组无可用渠道 → 自动切换下一个分组
    ↓
找到可用渠道 → 使用该渠道处理请求
```

**优势**：一个令牌可以使用多个分组的渠道，提高请求成功率。

### 3. 跨分组重试

- **仅在分组为 `auto` 时显示**
- 开启后，当前分组渠道失败时会按顺序尝试下一个分组的渠道
- 适合对可用性要求高的场景

### 4. 过期时间

| 选项 | 说明 |
|-----|------|
| 永不过期 | 设为 `-1`，令牌永久有效 |
| 指定时间 | 选择具体的过期日期时间 |
| 快捷设置 | 一个月、一天、一小时 |

### 5. 额度设置

| 选项 | 说明 |
|-----|------|
| 无限额度 | 令牌不限制使用量，实际消费受账户余额限制 |
| 指定额度 | 设置令牌最大可用额度 |

**额度换算**：
- 500,000 额度 = $1
- 常用预设：1$、10$、50$、100$、500$、1000$

**注意**：令牌额度仅限制令牌本身的最大使用量，实际消费仍受账户余额限制。

### 6. 模型限制

- **非必填**，留空表示支持所有模型
- 可选择该令牌允许调用的模型列表
- 建议：非必要不启用，避免限制灵活性

### 7. IP 白名单

- 限制只有指定 IP 可以使用该令牌
- 一行一个 IP
- **注意**：IP 可能被伪造，不要过度依赖此功能

### 8. 新建数量

- 批量创建令牌的数量
- 批量创建时会在名称后自动添加随机后缀

## 四、用户可选分组的来源

用户创建令牌时可选择的分组由**三层配置**共同决定：

### 第一层：基础可用分组（UserUsableGroups）

**配置位置**：管理后台 → 倍率设置 → 用户可用分组

**代码位置**：`setting/user_usable_group.go`

```go
var userUsableGroups = map[string]string{
    "default": "默认分组",
    "vip":     "vip分组",
}
```

这是**所有用户**的基础可选分组列表。

### 第二层：分组特殊可用分组（GroupSpecialUsableGroup）

**配置位置**：管理后台 → 倍率设置 → 分组特殊可用分组

**代码位置**：`service/group.go`

针对**特定用户分组**，可以增加或移除可选分组：

| 配置格式 | 作用 |
|---------|------|
| `+:groupname` | 为该用户分组添加可选分组 |
| `-:groupname` | 为该用户分组移除可选分组 |
| `groupname` | 直接添加可选分组 |

**示例**：
```json
{
  "vip": {
    "+:premium": "高级分组",
    "-:free": ""
  }
}
```
表示 VIP 用户可以额外选择 `premium` 分组，但不能选择 `free` 分组。

### 第三层：用户自身分组自动补充

如果用户的分组不在 `UserUsableGroups` 中，系统会**自动添加用户自身的分组**。

**代码位置**：`service/group.go:31-34`

```go
if _, ok := groupsCopy[userGroup]; !ok {
    groupsCopy[userGroup] = "用户分组"
}
```

### 完整计算公式

```
用户可选分组 = UserUsableGroups（基础）
             + GroupSpecialUsableGroup 添加的分组
             - GroupSpecialUsableGroup 移除的分组
             + 用户自身分组（如果不在列表中）
             + "auto"（如果已配置）
```

### 计算示例

| 配置项 | 值 |
|-------|-----|
| UserUsableGroups | `{"default", "vip", "auto"}` |
| 用户分组 | `premium` |
| GroupSpecialUsableGroup["premium"] | `{"+:exclusive", "-:vip"}` |

**该用户最终可选分组**：
- `default` ✓（来自基础配置）
- `vip` ✗（被特殊配置移除）
- `auto` ✓（来自基础配置）
- `exclusive` ✓（被特殊配置添加）
- `premium` ✓（用户自身分组自动补充）

## 五、分组与渠道的关系

```
令牌分组 → 决定可用渠道范围 → 影响请求路由
```

| 令牌分组 | 可用渠道 |
|---------|---------|
| `default` | 只能使用 default 分组的渠道 |
| `vip` | 只能使用 vip 分组的渠道 |
| `auto` | 可使用 AutoGroups 列表中所有分组的渠道 |

### AutoGroups 配置

**配置位置**：管理后台 → 倍率设置 → 自动分组

**代码位置**：`setting/auto_group.go`

```go
var autoGroups = []string{
    "default",
}
```

管理员可配置 `auto` 分组按什么顺序尝试哪些分组。

## 六、初始令牌自动生成

### 环境变量配置

| 变量名 | 默认值 | 说明 |
|-------|-------|------|
| `GENERATE_DEFAULT_TOKEN` | `false` | 是否为新注册用户自动生成初始令牌 |

### 初始令牌属性

当 `GENERATE_DEFAULT_TOKEN=true` 时，新用户注册成功后自动生成的令牌属性：

| 属性 | 值 |
|-----|-----|
| 名称 | `{用户名}的初始令牌` |
| 过期时间 | `-1`（永不过期） |
| 初始额度 | `500000` |
| 无限额度 | `true` |
| 模型限制 | `false`（不启用） |
| 分组 | 如果 `DefaultUseAutoGroup=true`，则为 `auto`；否则留空 |

**代码位置**：`controller/user.go:319-351`

## 七、DefaultUseAutoGroup 配置

**配置位置**：管理后台 → 倍率设置 → 创建令牌默认选择auto分组

**代码位置**：`setting/auto_group.go:11`

| 值 | 效果 |
|---|------|
| `false` | 创建令牌时分组默认留空（使用用户默认分组） |
| `true` | 创建令牌时分组默认选择 `auto`，初始令牌也设为 `auto` |

**重要**：此配置生效的前提条件：

1. **用户可用分组（UserUsableGroups）中必须包含 `auto`**，否则用户看不到 `auto` 选项
2. 配置示例：
```json
{
  "default": "默认分组",
  "vip": "vip分组",
  "auto": "自动分组"
}
```

如果只开启了 `DefaultUseAutoGroup` 但 `UserUsableGroups` 中没有 `auto`，创建令牌时不会显示 `auto` 选项，也不会默认选中。

## 八、令牌使用流程

```
1. 用户创建令牌
       ↓
2. 获取令牌 Key（sk-xxx）
       ↓
3. 在 API 请求中使用
   Authorization: Bearer sk-xxx
       ↓
4. 系统验证令牌
   - 检查令牌是否存在
   - 检查是否过期
   - 检查额度是否充足
   - 检查 IP 白名单
   - 检查模型限制
       ↓
5. 根据令牌分组选择渠道
       ↓
6. 转发请求到上游
       ↓
7. 扣除令牌和用户额度
```

## 九、常见问题

### Q1: 令牌分组和用户分组有什么区别？

- **用户分组**：用户账户的属性，决定用户可以选择哪些令牌分组
- **令牌分组**：令牌的属性，决定该令牌可以使用哪些渠道

### Q2: 为什么创建令牌时看不到某些分组？

检查以下配置：
1. 管理后台 → 倍率设置 → 用户可用分组，是否包含该分组
2. 是否被 GroupSpecialUsableGroup 移除
3. 该分组是否在 GroupRatio 中定义

### Q3: 为什么开启了「创建令牌默认选择auto分组」但创建时没有默认选中 auto？

需要同时满足两个条件：
1. **用户可用分组** 中包含 `auto`（如 `{"default": "默认分组", "auto": "自动分组"}`）
2. **创建令牌默认选择auto分组** 开关已开启

如果只开启了开关但用户可用分组中没有 `auto`，则不会生效。

### Q4: auto 分组和固定分组如何选择？

| 场景 | 推荐 |
|-----|------|
| 需要高可用性 | `auto` + 开启跨分组重试 |
| 需要固定成本 | 固定分组（如 `default`） |
| 需要使用特定渠道 | 固定分组 |

### Q5: 令牌额度用完了怎么办？

- 如果开启了无限额度：不受令牌额度限制
- 如果设置了固定额度：需要编辑令牌增加额度，或创建新令牌

## 十、API 接口

### 创建令牌

```
POST /api/token/
```

**请求体**：
```json
{
  "name": "my-token",
  "remain_quota": 500000,
  "expired_time": -1,
  "unlimited_quota": true,
  "model_limits_enabled": false,
  "model_limits": "",
  "allow_ips": "",
  "group": "auto",
  "cross_group_retry": false
}
```

### 获取用户可用分组

```
GET /api/user/self/groups
```

**响应**：
```json
{
  "success": true,
  "data": {
    "default": {
      "ratio": 1,
      "desc": "默认分组"
    },
    "auto": {
      "ratio": "自动",
      "desc": "自动分组"
    }
  }
}
```
