# 监控设置详解

## 一、配置项说明

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| **定时测试所有通道** | 是否启用自动定时测试 | 关闭 |
| **自动测试所有通道间隔时间** | 每隔多少分钟测试一次 | 10 分钟 |
| **并行测试通道** | 是否并行测试多个通道 | 关闭 |
| **并行测试并发数** | 同时测试的通道数量 | 5 |
| **测试所有渠道的最长响应时间** | 超过此时间自动禁用 | 5 秒 |
| **额度提醒阈值** | 低于此额度发送邮件提醒 | 1000 Token |
| **失败时自动禁用通道** | 测试失败是否自动禁用 | 关闭 |
| **成功时自动启用通道** | 测试成功是否自动启用 | 关闭 |
| **自动禁用关键词** | 包含这些关键词时自动禁用 | 见下方 |

---

## 二、定时测试流程

### 启动入口

程序启动时会启动定时测试线程：

```go
go controller.AutomaticallyTestChannels()
```

### 定时循环逻辑

```
┌─────────────────────────────────────────────────────────────┐
│                  AutomaticallyTestChannels                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 检查是否为 Master 节点                                   │
│     └─ 非 Master → 直接返回（避免多节点重复测试）            │
│                                                              │
│  2. 进入无限循环                                             │
│     ┌──────────────────────────────────────────────────┐    │
│     │  检查 AutoTestChannelEnabled 是否启用             │    │
│     │  └─ 未启用 → 休眠 1 分钟，继续检查                │    │
│     │  └─ 已启用 → 进入测试循环                         │    │
│     │                                                    │    │
│     │  测试循环：                                        │    │
│     │  ├─ 休眠 AutoTestChannelMinutes 分钟              │    │
│     │  ├─ 执行 testAllChannels(false)                   │    │
│     │  └─ 检查是否仍启用，否则退出内层循环              │    │
│     └──────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、测试所有通道流程

```
┌─────────────────────────────────────────────────────────────┐
│                     testAllChannels                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 加锁检查（防止并发执行）                                 │
│     └─ 已在运行 → 返回错误 "测试已在运行中"                  │
│                                                              │
│  2. 获取需要测试的通道                                       │
│     └─ 包括：启用、自动禁用的通道                            │
│     └─ 排除：手动禁用的通道（不参与监控测试）                │
│     └─ 目的：自动禁用的通道测试成功后可自动恢复              │
│                                                              │
│  3. 启动 goroutine 异步执行测试                              │
│     │                                                        │
│     ▼                                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  判断测试模式                                        │    │
│  │                                                      │    │
│  │  并行模式 (AutoTestChannelParallel = true)：         │    │
│  │  ├─ 创建信号量 sem (容量 = 并发数)                   │    │
│  │  ├─ 为每个通道启动 goroutine                         │    │
│  │  ├─ 通过信号量控制并发数                             │    │
│  │  └─ 等待所有测试完成                                 │    │
│  │                                                      │    │
│  │  顺序模式 (AutoTestChannelParallel = false)：        │    │
│  │  ├─ 逐个测试通道                                     │    │
│  │  └─ 每次测试后休眠 RequestInterval                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  4. 测试完成后发送通知（如果 notify = true）                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、单个通道测试逻辑

```
┌─────────────────────────────────────────────────────────────┐
│                    testSingleChannel                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 记录开始时间                                             │
│                                                              │
│  2. 执行测试请求 testChannel()                               │
│     └─ 发送一个简单的 AI 请求验证通道可用性                  │
│                                                              │
│  3. 计算响应时间 (毫秒)                                      │
│                                                              │
│  4. 判断是否应该禁用通道                                     │
│     │                                                        │
│     ├─ 请求出错 → ShouldDisableChannel() 判断                │
│     │                                                        │
│     └─ 响应超时 → 响应时间 > 阈值 → 标记禁用                 │
│                                                              │
│  5. 执行禁用/启用操作                                        │
│     │                                                        │
│     ├─ 通道启用 + 应禁用 + AutoBan开启                       │
│     │  └─ 调用 DisableChannel() 禁用通道                     │
│     │                                                        │
│     └─ 通道禁用 + 测试成功 + 状态为自动禁用                  │
│        └─ 调用 EnableChannel() 启用通道                      │
│                                                              │
│  6. 更新通道响应时间记录                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、自动禁用判断逻辑

`ShouldDisableChannel` 函数判断是否应该禁用通道：

```
┌─────────────────────────────────────────────────────────────┐
│                   ShouldDisableChannel                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  前置检查：                                                  │
│  ├─ AutomaticDisableChannelEnabled = false → 返回 false     │
│  └─ err = nil → 返回 false                                   │
│                                                              │
│  错误类型检查：                                              │
│  ├─ IsChannelError (渠道级错误) → 返回 true                  │
│  └─ IsSkipRetryError (跳过重试错误) → 返回 false             │
│                                                              │
│  HTTP 状态码检查：                                           │
│  ├─ 401 Unauthorized → 返回 true                             │
│  └─ 403 Forbidden (Gemini) → 返回 true                       │
│                                                              │
│  OpenAI 错误码检查：                                         │
│  ├─ invalid_api_key → true                                   │
│  ├─ account_deactivated → true                               │
│  ├─ billing_not_active → true                                │
│  └─ Arrearage → true                                         │
│                                                              │
│  OpenAI 错误类型检查：                                       │
│  ├─ insufficient_quota → true                                │
│  ├─ authentication_error → true                              │
│  ├─ permission_error → true                                  │
│  └─ forbidden → true                                         │
│                                                              │
│  关键词匹配（Aho-Corasick 算法）：                           │
│  └─ 错误信息包含自动禁用关键词 → 返回 true                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、自动禁用关键词

默认关键词列表：

```
Your credit balance is too low        # 余额不足
This organization has been disabled.  # 组织已禁用
You exceeded your current quota       # 超出配额
Permission denied                     # 权限拒绝
The security token included in the request is invalid  # 令牌无效
Operation not allowed                 # 操作不允许
Your account is not authorized        # 账户未授权
```

**匹配算法**：使用 **Aho-Corasick 多模式匹配算法**，可以高效地在错误信息中同时搜索多个关键词（不区分大小写）。

---

## 七、自动启用判断逻辑

`ShouldEnableChannel` 函数判断是否应该自动启用通道：

```
┌─────────────────────────────────────────────────────────────┐
│                    ShouldEnableChannel                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  必须同时满足以下条件：                                      │
│                                                              │
│  1. AutomaticEnableChannelEnabled = true                     │
│     └─ 启用了"成功时自动启用通道"功能                        │
│                                                              │
│  2. newAPIError = nil                                        │
│     └─ 测试请求没有错误（成功）                              │
│                                                              │
│  3. status = ChannelStatusAutoDisabled                       │
│     └─ 通道当前状态是"自动禁用"                              │
│     └─ 手动禁用的通道不会自动启用                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、完整监控流程图

```
                    ┌─────────────────┐
                    │   程序启动       │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 启动定时测试线程 │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                              │
              ▼                              │
     ┌────────────────┐                      │
     │ 定时测试已启用? │──否──▶ 休眠1分钟 ───┘
     └───────┬────────┘
             │是
             ▼
     ┌────────────────┐
     │ 休眠 N 分钟     │
     └───────┬────────┘
             │
             ▼
     ┌─────────────────────────┐
     │ 获取需要测试的通道       │
     │ (排除手动禁用的通道)     │
     └───────────┬─────────────┘
             │
             ▼
     ┌────────────────┐
     │ 并行/顺序测试   │
     └───────┬────────┘
             │
    ┌────────┴────────┐
    │  对每个通道      │
    ▼                  │
┌───────────┐          │
│ 发送测试请求│          │
└─────┬─────┘          │
      │                │
      ▼                │
┌───────────┐          │
│ 检查结果   │          │
└─────┬─────┘          │
      │                │
  ┌───┴───┐            │
  │       │            │
  ▼       ▼            │
成功     失败           │
  │       │            │
  ▼       ▼            │
┌─────┐ ┌─────────┐    │
│启用? │ │应该禁用?│    │
└──┬──┘ └────┬────┘    │
   │         │         │
   ▼         ▼         │
自动启用  自动禁用      │
   │         │         │
   └────┬────┘         │
        │              │
        ▼              │
   更新响应时间 ────────┘
```

---

## 九、通知机制

当通道状态变化时，系统会通过以下方式通知管理员：

1. **邮件通知**：发送到 Root 用户的邮箱
2. **通知内容**：
   - 禁用：`通道「xxx」（#id）已被禁用，原因：xxx`
   - 启用：`通道「xxx」（#id）已被启用`

---

## 十、相关代码文件

| 文件路径 | 说明 |
|---------|------|
| `controller/channel-test.go` | 通道测试核心逻辑 |
| `service/channel.go` | 禁用/启用判断逻辑 |
| `setting/operation_setting/monitor_setting.go` | 监控设置配置 |
| `setting/operation_setting/operation_setting.go` | 自动禁用关键词配置 |
| `main.go` | 定时测试启动入口 |
